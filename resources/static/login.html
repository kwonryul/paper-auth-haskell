<html>
    <head>
        <title>
            Paper-Auth Login
        </title>
        <script>
            let db;
            let request = indexedDB.open('myDatabase', 1);

            request.onerror = function(event) {
                alert('error opening indexed db');
            }
            request.onsuccess = function(event) {
                db = request.result;
            }
            request.onupgradeneeded = function(event) {
                let db = event.target.result;
                let objectStore = db.createObjectStore('tokenStore');
            }

            function paperAuth() {
            }

            function openSocket(name) {
                let socket = new WebSocket('wss://43.200.64.248/oauth2/client/webSocket');
                let count = 0;
                socket.onmessage = function(event) {
                    count++;
                    if (count === 1) {
                        console.log('state:\t' + event.data);
                        window.open('https://43.200.64.248/oauth2/client/issue/' + name + '?code=something&state=' + event.data, 'newWindow', 'width=600, height=400');
                    } else {
                        console.log('msg:\t' + event.data);
                        let at = JSON.parse(event.data).accessToken;
                        let request = db.transaction(['tokenStore'], 'readwrite')
                            .objectStore('tokenStore')
                            .put({ token: at }, 'accessToken');
                        request.onsuccess = function(event) {
                            window.location = '/static/index.html';
                        }
                        request.onerror = function(event) {
                            console.dir(event);
                        }
                    }
                };
                socket.onerror = function(error) {
                    console.error(error);
                };
                socket.onclose = function(event) {
                    console.log('socket connection closed');
                    setTimeout(() => { alert('internal server error'); }, 10000);
                };
            }

        </script>
    </head>
    <body>
        <label for='paperId'>아이디</label>
        <input type='text' id='paperId'>
        <label for='password'>비밀번호</label>
        <input type='password' id='password'>
        <p>
            <button onclick='paperAuth()'>로그인</button>
        </p>
        <p>
            <a href='/static/enroll.html'>회원 가입</a>
        </p>
        <p>
            <button onclick='openSocket("kakao");'>Kakao</button>
        </p>
        <p>
            <button onclick='openSocket("naver")'>Naver</button>
        </p>
    </body>
</html>