<html>
    <head>
        <title>
            Paper-Auth Index
        </title>
        <script>
            let db;

            function openDB() {
                let request = indexedDB.open('myDatabase', 1);

                request.onerror = function(event) {
                    alert('error opening indexed db');
                }
                request.onsuccess = function(event) {
                    db = request.result;
                    getUserInfo();
                }
                request.onupgradeneeded = function(event) {
                    db = event.target.result;
                    let objectStore = db.createObjectStore('tokenStore');
                }
            }

            function getUserInfo() {
                let transaction = db.transaction(["tokenStore"]);
                let objectStore = transaction.objectStore("tokenStore");
                let request = objectStore.get('accessToken');
                request.onsuccess = function(event) {
                    if (request.result && request.result.token) {
                        let headers = new Headers();
                        headers.append('Authorization', 'Bearer ' + request.result.token);
                        fetch('https://43.200.64.248/user/userInfo', {
                            headers,
                            credentials: 'include' })
                            .then(res => {
                                if (!res.ok) {
                                    if (res.status === 401 || res.status === 403)
                                        window.location = 'https://43.200.64.248/static/login.html';
                                    else
                                        alert('internal server error');
                                }
                                res.json().then(j => {
                                    document.getElementById('roleSet')
                                        .value = JSON.stringify(j.roleSet);
                                    document.getElementById('name')
                                        .value = j.name;
                                    document.getElementById('phoneNumber')
                                        .value = j.phoneNumber;
                                    document.getElementById('registerDate')
                                        .value = j.registerDate;
                                });
                            });
                    } else {
                        window.location = 'https://43.200.64.248/static/login.html';
                    }
                }
                request.onerror = function(event) {
                    alert('error using indexed db');
                }
            }

            function logout() {
                let transaction = db.transaction(["tokenStore"]);
                let objectStore = transaction.objectStore("tokenStore");
                let request = objectStore.get('accessToken');
                request.onsuccess = function(event) {
                    if (request.result && request.result.token) {
                        let headers = new Headers();
                        headers.append('Authorization', 'Bearer ' + request.result.token);
                        fetch('https://43.200.64.248/jwt/invalidate', {
                            method: "DELETE",
                            headers,
                            credentials: 'include' })
                            .then(res => {
                                if (!res.ok)
                                    alert('internal server error');
                                else {
                                    window.location = 'https://43.200.64.248/static/login.html';
                                }
                            });
                    } else {
                        window.location = 'https://43.200.64.248/static/login.html';
                    }
                }
                request.onerror = function(event) {
                    alert('error using indexed db');
                }
            }

            function ready(callbackFunc) {
                if (document.readyState !== 'loading')
                    callbackFunc();
                else
                    document.addEventListener('DOMContentLoaded', callbackFunc);
            }

            function patchUserInfo() {
            }

            ready(openDB)
        </script>
    </head>
    <body>
        <label for='roleSet'>유저 권한</label>
        <input type='text' id='roleSet'>
        <label for='name'>닉네임</label>
        <input type='text' id='name'>
        <label for='phoneNumber'>핸드폰 번호</label>
        <input type='text' id='phoneNumber'>
        <label for='registerDate'>가입 날짜</label>
        <input type='text' id='registerDate'>
        <p>
            <button onclick='logout();'>로그아웃</button>
        </p>
    </body>
</html>